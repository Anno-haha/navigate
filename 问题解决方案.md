# ADS-B系统问题解决方案

## 🎯 问题分析

您遇到的两个主要问题：

### 1. nav.py无法输出数据
**原因**: nav.py进程可能意外停止或暂停
**现象**: adsb_decoded.log文件停止更新

### 2. start_both.py无法运行  
**原因**: 
- Unicode编码问题（Windows控制台无法显示emoji）
- 进程冲突检测不准确
- 端口占用问题

## ✅ 解决方案

### 🔧 修复的问题

#### 1. Unicode编码问题
**修改前**:
```python
print("✅ 检测到nav.py正在运行，数据采集正常")
print("❌ 检查nav.py状态失败")
```

**修改后**:
```python
print("[OK] 检测到nav.py正在运行，数据采集正常")
print("[ERROR] 检查nav.py状态失败")
```

#### 2. 进程检测优化
**修改前**: 复杂的psutil进程检测
**修改后**: 简单的日志文件时间戳检测
```python
def check_nav_py_running():
    if os.path.exists('adsb_decoded.log'):
        mtime = os.path.getmtime('adsb_decoded.log')
        if time.time() - mtime < 60:  # 1分钟内有更新
            return True, "active"
    return False, None
```

#### 3. 端口冲突处理
**修改前**: 简单的端口检测
**修改后**: 智能端口查找
```python
def find_available_port(start_port=8000, max_port=8020):
    for port in range(start_port, max_port):
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
                s.bind(('127.0.0.1', port))
                return port
        except OSError:
            continue
    return None
```

#### 4. 飞机数据整合
**新增功能**: 为每架飞机维护完整历史记录
```python
aircraft_data[icao] = {
    'icao': icao,
    'update_count': count,           # 更新次数
    'positions': [enu_coords],       # 位置历史
    'altitudes': [altitude],         # 高度历史
    'max_altitude': max_alt,         # 最高高度
    'min_altitude': min_alt,         # 最低高度
    'avg_altitude': avg_alt,         # 平均高度
    'speed': calculated_speed,       # 计算速度
    'first_seen': first_time,        # 首次发现
    'last_seen': last_time,          # 最后更新
}
```

### 🛠️ 新增工具

#### 1. 诊断工具 (diagnose.py)
- 文件完整性检查
- nav.py状态检查
- 端口可用性检查
- 数据流检查
- 自动问题诊断

#### 2. 改进的启动脚本 (start_both.py)
- 智能进程检测
- 避免重复启动
- 更好的错误处理
- 清晰的状态显示

## 🚀 推荐使用方法

### 方法一：手动分别启动（最稳定）
```bash
# 终端1：启动数据采集
python nav.py

# 终端2：启动可视化系统  
python simple_visual.py
```

### 方法二：诊断后启动
```bash
# 1. 先诊断系统状态
python diagnose.py

# 2. 根据诊断结果启动
python start_both.py
```

### 方法三：快速检查
```bash
# 快速检查系统状态
python start_both.py --check
```

## 📊 系统状态验证

### ✅ 正常运行的标志
1. **nav.py状态**: 控制台持续输出飞机数据
2. **日志文件**: adsb_decoded.log文件持续更新
3. **可视化系统**: 浏览器显示实时飞机数据
4. **API响应**: http://127.0.0.1:8000/api/aircraft/ 返回JSON数据

### 🔍 故障排除步骤
1. **检查nav.py**: 确保ADS-B接收器连接正常
2. **检查串口**: 确认COM3端口可用
3. **检查日志**: 查看adsb_decoded.log是否更新
4. **检查端口**: 确认8000端口未被占用
5. **重启系统**: 按顺序重启nav.py和可视化系统

## 🎨 界面改进效果

### 飞机数据整合显示
现在每架飞机显示：
- **更新次数徽章**: 显示检测次数
- **高度统计面板**: 最高/最低/平均高度
- **时间信息面板**: 首次发现、跟踪时长
- **动态信息**: 实时计算的飞行速度
- **详细坐标**: 可展开的ENU坐标信息

### 系统状态监控
- **实时状态指示**: 绿色圆点表示系统在线
- **自动数据清理**: 10分钟过期数据自动清理
- **智能缓存**: 保留最近20个位置记录
- **错误恢复**: 完善的异常处理机制

## 📈 性能优化

### 数据处理优化
- **增量读取**: 只处理新增日志数据
- **内存管理**: 自动清理过期飞机数据
- **并发处理**: 使用ThreadingTCPServer支持多用户

### 网络优化
- **智能端口**: 自动选择可用端口
- **数据压缩**: 优化API响应大小
- **缓存策略**: 合理的数据刷新间隔

## 🎉 最终效果

现在您的系统具备：

✅ **稳定运行**: nav.py和可视化系统可以并行运行  
✅ **数据整合**: 同一架飞机的完整历史信息  
✅ **智能监控**: 自动状态检测和错误恢复  
✅ **用户友好**: 现代化界面和清晰的状态显示  
✅ **易于维护**: 完善的诊断工具和文档  

## 💡 使用建议

1. **日常使用**: 使用手动分别启动方式最稳定
2. **问题诊断**: 遇到问题时先运行diagnose.py
3. **系统监控**: 观察绿色状态点确认系统正常
4. **数据验证**: 定期检查API接口确认数据更新

**现在您的ADS-B可视化系统已经完全优化，可以稳定持续运行！** ✈️📊🌍
