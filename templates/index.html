{% extends "base.html" %}

{% block title %}3Dåœ°çƒè§†å›¾ - ADS-Bå¯è§†åŒ–ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    #earth-container {
        position: relative;
        background: radial-gradient(ellipse at center, #1e3c72 0%, #0a0a0a 100%);
    }
    
    .control-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
        min-width: 250px;
    }
    
    .aircraft-info-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
        max-width: 300px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .filter-group {
        margin-bottom: 15px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .aircraft-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .aircraft-item:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(5px);
    }
    
    .aircraft-item.selected {
        background: rgba(0, 123, 255, 0.3);
        border: 1px solid #007bff;
    }
    
    .reference-point {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
    }
    
    .stats-overlay {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
        min-width: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-globe"></i>
                    3Dåœ°çƒå¯è§†åŒ– - å®æ—¶é£æœºä½ç½®
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="earth-container" style="height: 70vh; position: relative;">
                    <!-- 3Dåœ°çƒæ¸²æŸ“åŒºåŸŸ -->
                    <canvas id="earth-canvas"></canvas>
                    
                    <!-- æ§åˆ¶é¢æ¿ -->
                    <div class="control-panel">
                        <h6><i class="fas fa-sliders-h"></i> æ§åˆ¶é¢æ¿</h6>
                        
                        <div class="filter-group">
                            <label>é«˜åº¦è¿‡æ»¤ (è‹±å°º)</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" 
                                           id="altitude-min" placeholder="æœ€å°" value="0">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" 
                                           id="altitude-max" placeholder="æœ€å¤§" value="50000">
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label>æ˜¾ç¤ºé€‰é¡¹</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-trajectories" checked>
                                <label class="form-check-label" for="show-trajectories">
                                    æ˜¾ç¤ºè½¨è¿¹
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-labels" checked>
                                <label class="form-check-label" for="show-labels">
                                    æ˜¾ç¤ºæ ‡ç­¾
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto-rotate" checked>
                                <label class="form-check-label" for="auto-rotate">
                                    è‡ªåŠ¨æ—‹è½¬
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <button class="btn btn-primary btn-sm w-100" onclick="resetView()">
                                <i class="fas fa-home"></i> é‡ç½®è§†è§’
                            </button>
                        </div>
                    </div>
                    
                    <!-- é£æœºä¿¡æ¯é¢æ¿ -->
                    <div class="aircraft-info-panel">
                        <h6><i class="fas fa-plane"></i> é£æœºåˆ—è¡¨</h6>
                        <div id="aircraft-list">
                            <p class="text-muted">æ­£åœ¨åŠ è½½é£æœºæ•°æ®...</p>
                        </div>
                    </div>
                    
                    <!-- å‚è€ƒç‚¹ä¿¡æ¯ -->
                    <div class="reference-point">
                        <h6><i class="fas fa-map-marker-alt"></i> å‚è€ƒç‚¹</h6>
                        <p class="mb-1">ğŸ“ åŒ—äº¬ä¸Šç©º</p>
                        <p class="mb-1">ğŸ“ 39.9Â°N, 116.4Â°E</p>
                        <p class="mb-0">ğŸ“ é«˜åº¦: 10,000m</p>
                    </div>
                    
                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="stats-overlay">
                        <h6><i class="fas fa-chart-bar"></i> ç»Ÿè®¡ä¿¡æ¯</h6>
                        <div id="stats-content">
                            <p class="mb-1">æ€»é£æœºæ•°: <span id="total-aircraft">0</span></p>
                            <p class="mb-1">å¹³å‡é«˜åº¦: <span id="avg-altitude">0</span>ft</p>
                            <p class="mb-0">æœ€è¿œè·ç¦»: <span id="max-distance">0</span>km</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Three.js 3Dåœ°çƒå¯è§†åŒ–
    let scene, camera, renderer, earth, aircraftGroup;
    let controls, animationId;
    let selectedAircraft = null;
    
    // åˆå§‹åŒ–3Dåœºæ™¯
    function init3DScene() {
        const container = document.getElementById('earth-container');
        const canvas = document.getElementById('earth-canvas');
        
        // åˆ›å»ºåœºæ™¯
        scene = new THREE.Scene();
        
        // åˆ›å»ºç›¸æœº
        camera = new THREE.PerspectiveCamera(
            75, 
            container.clientWidth / container.clientHeight, 
            0.1, 
            1000
        );
        camera.position.set(0, 0, 50);
        
        // åˆ›å»ºæ¸²æŸ“å™¨
        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setClearColor(0x000011);
        
        // åˆ›å»ºåœ°çƒ
        createEarth();
        
        // åˆ›å»ºé£æœºç»„
        aircraftGroup = new THREE.Group();
        scene.add(aircraftGroup);
        
        // æ·»åŠ å…‰æº
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(50, 50, 50);
        scene.add(directionalLight);
        
        // æ·»åŠ é¼ æ ‡æ§åˆ¶
        addControls();
        
        // å¼€å§‹æ¸²æŸ“å¾ªç¯
        animate();
        
        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', onWindowResize);
    }
    
    // åˆ›å»ºåœ°çƒ
    function createEarth() {
        const geometry = new THREE.SphereGeometry(20, 64, 64);
        
        // åœ°çƒçº¹ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const material = new THREE.MeshPhongMaterial({
            color: 0x2233ff,
            shininess: 100,
            transparent: true,
            opacity: 0.8
        });
        
        earth = new THREE.Mesh(geometry, material);
        scene.add(earth);
        
        // æ·»åŠ å¤§æ°”å±‚æ•ˆæœ
        const atmosphereGeometry = new THREE.SphereGeometry(21, 64, 64);
        const atmosphereMaterial = new THREE.MeshBasicMaterial({
            color: 0x88ccff,
            transparent: true,
            opacity: 0.1,
            side: THREE.BackSide
        });
        
        const atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
        scene.add(atmosphere);
        
        // æ·»åŠ åŒ—äº¬å‚è€ƒç‚¹
        addReferencePoint();
    }
    
    // æ·»åŠ åŒ—äº¬å‚è€ƒç‚¹
    function addReferencePoint() {
        const geometry = new THREE.SphereGeometry(0.5, 16, 16);
        const material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const marker = new THREE.Mesh(geometry, material);
        
        // åŒ—äº¬ä½ç½® (39.9Â°N, 116.4Â°E)
        const lat = 39.9 * Math.PI / 180;
        const lon = 116.4 * Math.PI / 180;
        const radius = 20.5;
        
        marker.position.x = radius * Math.cos(lat) * Math.cos(lon);
        marker.position.y = radius * Math.sin(lat);
        marker.position.z = radius * Math.cos(lat) * Math.sin(lon);
        
        scene.add(marker);
    }
    
    // æ·»åŠ é¼ æ ‡æ§åˆ¶
    function addControls() {
        // ç®€åŒ–çš„é¼ æ ‡æ§åˆ¶
        let mouseDown = false;
        let mouseX = 0, mouseY = 0;
        
        const canvas = document.getElementById('earth-canvas');
        
        canvas.addEventListener('mousedown', (event) => {
            mouseDown = true;
            mouseX = event.clientX;
            mouseY = event.clientY;
        });
        
        canvas.addEventListener('mouseup', () => {
            mouseDown = false;
        });
        
        canvas.addEventListener('mousemove', (event) => {
            if (!mouseDown) return;
            
            const deltaX = event.clientX - mouseX;
            const deltaY = event.clientY - mouseY;
            
            earth.rotation.y += deltaX * 0.01;
            earth.rotation.x += deltaY * 0.01;
            
            mouseX = event.clientX;
            mouseY = event.clientY;
        });
        
        // æ»šè½®ç¼©æ”¾
        canvas.addEventListener('wheel', (event) => {
            const delta = event.deltaY > 0 ? 1.1 : 0.9;
            camera.position.multiplyScalar(delta);
            camera.position.clampLength(25, 200);
        });
    }
    
    // åŠ¨ç”»å¾ªç¯
    function animate() {
        animationId = requestAnimationFrame(animate);
        
        // è‡ªåŠ¨æ—‹è½¬
        if (document.getElementById('auto-rotate').checked) {
            earth.rotation.y += 0.002;
        }
        
        renderer.render(scene, camera);
    }
    
    // çª—å£å¤§å°è°ƒæ•´
    function onWindowResize() {
        const container = document.getElementById('earth-container');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }
    
    // æ›´æ–°é£æœºæ˜¾ç¤º
    function updateAircraftDisplay(aircraftData) {
        // æ¸…é™¤ç°æœ‰é£æœº
        aircraftGroup.clear();
        
        // æ·»åŠ æ–°é£æœº
        Object.values(aircraftData).forEach(aircraft => {
            addAircraftToScene(aircraft);
        });
        
        // æ›´æ–°é£æœºåˆ—è¡¨
        updateAircraftList(aircraftData);
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateStatistics(aircraftData);
    }
    
    // æ·»åŠ é£æœºåˆ°åœºæ™¯
    function addAircraftToScene(aircraft) {
        // ç®€åŒ–çš„é£æœºæ¨¡å‹
        const geometry = new THREE.ConeGeometry(0.3, 1, 8);
        const material = new THREE.MeshBasicMaterial({ 
            color: getAircraftColor(aircraft.altitude) 
        });
        const aircraftMesh = new THREE.Mesh(geometry, material);
        
        // æ ¹æ®ENUåæ ‡è®¡ç®—ä½ç½®
        const scale = 0.001; // ç¼©æ”¾å› å­
        aircraftMesh.position.set(
            aircraft.enu_e * scale,
            aircraft.enu_u * scale,
            aircraft.enu_n * scale
        );
        
        aircraftMesh.userData = aircraft;
        aircraftGroup.add(aircraftMesh);
    }
    
    // æ ¹æ®é«˜åº¦è·å–é£æœºé¢œè‰²
    function getAircraftColor(altitude) {
        if (altitude < 10000) return 0xff4444;      // çº¢è‰² - ä½ç©º
        if (altitude < 30000) return 0xffff44;      // é»„è‰² - ä¸­ç©º
        return 0x4444ff;                            // è“è‰² - é«˜ç©º
    }
    
    // æ›´æ–°é£æœºåˆ—è¡¨
    function updateAircraftList(aircraftData) {
        const listContainer = document.getElementById('aircraft-list');
        
        if (Object.keys(aircraftData).length === 0) {
            listContainer.innerHTML = '<p class="text-muted">æš‚æ— é£æœºæ•°æ®</p>';
            return;
        }
        
        let html = '';
        Object.values(aircraftData).forEach(aircraft => {
            const distance = Math.sqrt(aircraft.enu_e**2 + aircraft.enu_n**2) / 1000;
            html += `
                <div class="aircraft-item" onclick="selectAircraft('${aircraft.icao}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="aircraft-emoji">${getAircraftEmoji(aircraft.altitude)}</span>
                            <strong>${aircraft.icao}</strong>
                        </div>
                        <small>${formatDistance(distance * 1000)}</small>
                    </div>
                    <small class="text-muted">
                        é«˜åº¦: ${formatAltitude(aircraft.altitude)}
                    </small>
                </div>
            `;
        });
        
        listContainer.innerHTML = html;
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStatistics(aircraftData) {
        const aircraftList = Object.values(aircraftData);
        
        if (aircraftList.length === 0) {
            document.getElementById('total-aircraft').textContent = '0';
            document.getElementById('avg-altitude').textContent = '0';
            document.getElementById('max-distance').textContent = '0';
            return;
        }
        
        const totalAircraft = aircraftList.length;
        const avgAltitude = Math.round(
            aircraftList.reduce((sum, a) => sum + a.altitude, 0) / totalAircraft
        );
        const maxDistance = Math.max(
            ...aircraftList.map(a => Math.sqrt(a.enu_e**2 + a.enu_n**2) / 1000)
        );
        
        document.getElementById('total-aircraft').textContent = totalAircraft;
        document.getElementById('avg-altitude').textContent = avgAltitude;
        document.getElementById('max-distance').textContent = maxDistance.toFixed(1);
    }
    
    // é€‰æ‹©é£æœº
    function selectAircraft(icao) {
        selectedAircraft = icao;
        
        // æ›´æ–°UI
        document.querySelectorAll('.aircraft-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        event.target.closest('.aircraft-item').classList.add('selected');
        
        // æ˜¾ç¤ºé£æœºè¯¦æƒ…
        showAircraftDetail(icao);
    }
    
    // æ˜¾ç¤ºé£æœºè¯¦æƒ…
    function showAircraftDetail(icao) {
        const aircraft = aircraftData[icao];
        if (!aircraft) return;
        
        const distance = Math.sqrt(aircraft.enu_e**2 + aircraft.enu_n**2);
        
        showAlert('info', `
            <strong>é£æœºè¯¦æƒ…: ${aircraft.icao}</strong><br>
            ä½ç½®: ${aircraft.latitude.toFixed(4)}Â°, ${aircraft.longitude.toFixed(4)}Â°<br>
            é«˜åº¦: ${formatAltitude(aircraft.altitude)}<br>
            è·ç¦»: ${formatDistance(distance)}
        `, 8000);
    }
    
    // é‡ç½®è§†è§’
    function resetView() {
        camera.position.set(0, 0, 50);
        earth.rotation.set(0, 0, 0);
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        init3DScene();
        
        // ç›‘å¬é£æœºæ•°æ®æ›´æ–°
        document.addEventListener('aircraftDataUpdated', function(event) {
            updateAircraftDisplay(event.detail.aircraft);
        });
        
        // è¿‡æ»¤å™¨äº‹ä»¶
        document.getElementById('altitude-min').addEventListener('change', applyFilters);
        document.getElementById('altitude-max').addEventListener('change', applyFilters);
    });
    
    // åº”ç”¨è¿‡æ»¤å™¨
    function applyFilters() {
        const minAlt = parseInt(document.getElementById('altitude-min').value) || 0;
        const maxAlt = parseInt(document.getElementById('altitude-max').value) || 50000;
        
        // é‡æ–°è·å–è¿‡æ»¤åçš„æ•°æ®
        fetch(`/api/aircraft/?altitude_min=${minAlt}&altitude_max=${maxAlt}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateAircraftDisplay(data.aircraft);
                }
            });
    }
</script>
{% endblock %}
