{% extends "base.html" %}

{% block title %}3D地球视图 - ADS-B可视化系统{% endblock %}

{% block extra_css %}
<style>
    #earth-container {
        position: relative;
        background: radial-gradient(ellipse at center, #1e3c72 0%, #0a0a0a 100%);
    }
    
    .control-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
        min-width: 250px;
    }
    
    .aircraft-info-panel {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
        max-width: 300px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .filter-group {
        margin-bottom: 15px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .aircraft-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .aircraft-item:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(5px);
    }
    
    .aircraft-item.selected {
        background: rgba(0, 123, 255, 0.3);
        border: 1px solid #007bff;
    }
    
    .reference-point {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
    }
    
    .stats-overlay {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 100;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
        min-width: 200px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-globe"></i>
                    3D地球可视化 - 实时飞机位置
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="earth-container" style="height: 70vh; position: relative;">
                    <!-- 3D地球渲染区域 -->
                    <canvas id="earth-canvas"></canvas>
                    
                    <!-- 控制面板 -->
                    <div class="control-panel">
                        <h6><i class="fas fa-sliders-h"></i> 控制面板</h6>
                        
                        <div class="filter-group">
                            <label>高度过滤 (英尺)</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" 
                                           id="altitude-min" placeholder="最小" value="0">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" 
                                           id="altitude-max" placeholder="最大" value="50000">
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label>显示选项</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-trajectories" checked>
                                <label class="form-check-label" for="show-trajectories">
                                    显示轨迹
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-labels" checked>
                                <label class="form-check-label" for="show-labels">
                                    显示标签
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto-rotate" checked>
                                <label class="form-check-label" for="auto-rotate">
                                    自动旋转
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <button class="btn btn-primary btn-sm w-100" onclick="resetView()">
                                <i class="fas fa-home"></i> 重置视角
                            </button>
                        </div>
                    </div>
                    
                    <!-- 飞机信息面板 -->
                    <div class="aircraft-info-panel">
                        <h6><i class="fas fa-plane"></i> 飞机列表</h6>
                        <div id="aircraft-list">
                            <p class="text-muted">正在加载飞机数据...</p>
                        </div>
                    </div>
                    
                    <!-- 参考点信息 -->
                    <div class="reference-point">
                        <h6><i class="fas fa-map-marker-alt"></i> 参考点</h6>
                        <p class="mb-1">📍 北京上空</p>
                        <p class="mb-1">📐 39.9°N, 116.4°E</p>
                        <p class="mb-0">📏 高度: 10,000m</p>
                    </div>
                    
                    <!-- 统计信息 -->
                    <div class="stats-overlay">
                        <h6><i class="fas fa-chart-bar"></i> 统计信息</h6>
                        <div id="stats-content">
                            <p class="mb-1">总飞机数: <span id="total-aircraft">0</span></p>
                            <p class="mb-1">平均高度: <span id="avg-altitude">0</span>ft</p>
                            <p class="mb-0">最远距离: <span id="max-distance">0</span>km</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Three.js 3D地球可视化
    let scene, camera, renderer, earth, aircraftGroup;
    let controls, animationId;
    let selectedAircraft = null;
    
    // 初始化3D场景
    function init3DScene() {
        const container = document.getElementById('earth-container');
        const canvas = document.getElementById('earth-canvas');
        
        // 创建场景
        scene = new THREE.Scene();
        
        // 创建相机
        camera = new THREE.PerspectiveCamera(
            75, 
            container.clientWidth / container.clientHeight, 
            0.1, 
            1000
        );
        camera.position.set(0, 0, 50);
        
        // 创建渲染器
        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setClearColor(0x000011);
        
        // 创建地球
        createEarth();
        
        // 创建飞机组
        aircraftGroup = new THREE.Group();
        scene.add(aircraftGroup);
        
        // 添加光源
        const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(50, 50, 50);
        scene.add(directionalLight);
        
        // 添加鼠标控制
        addControls();
        
        // 开始渲染循环
        animate();
        
        // 窗口大小调整
        window.addEventListener('resize', onWindowResize);
    }
    
    // 创建地球
    function createEarth() {
        const geometry = new THREE.SphereGeometry(20, 64, 64);
        
        // 地球纹理（简化版）
        const material = new THREE.MeshPhongMaterial({
            color: 0x2233ff,
            shininess: 100,
            transparent: true,
            opacity: 0.8
        });
        
        earth = new THREE.Mesh(geometry, material);
        scene.add(earth);
        
        // 添加大气层效果
        const atmosphereGeometry = new THREE.SphereGeometry(21, 64, 64);
        const atmosphereMaterial = new THREE.MeshBasicMaterial({
            color: 0x88ccff,
            transparent: true,
            opacity: 0.1,
            side: THREE.BackSide
        });
        
        const atmosphere = new THREE.Mesh(atmosphereGeometry, atmosphereMaterial);
        scene.add(atmosphere);
        
        // 添加北京参考点
        addReferencePoint();
    }
    
    // 添加北京参考点
    function addReferencePoint() {
        const geometry = new THREE.SphereGeometry(0.5, 16, 16);
        const material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const marker = new THREE.Mesh(geometry, material);
        
        // 北京位置 (39.9°N, 116.4°E)
        const lat = 39.9 * Math.PI / 180;
        const lon = 116.4 * Math.PI / 180;
        const radius = 20.5;
        
        marker.position.x = radius * Math.cos(lat) * Math.cos(lon);
        marker.position.y = radius * Math.sin(lat);
        marker.position.z = radius * Math.cos(lat) * Math.sin(lon);
        
        scene.add(marker);
    }
    
    // 添加鼠标控制
    function addControls() {
        // 简化的鼠标控制
        let mouseDown = false;
        let mouseX = 0, mouseY = 0;
        
        const canvas = document.getElementById('earth-canvas');
        
        canvas.addEventListener('mousedown', (event) => {
            mouseDown = true;
            mouseX = event.clientX;
            mouseY = event.clientY;
        });
        
        canvas.addEventListener('mouseup', () => {
            mouseDown = false;
        });
        
        canvas.addEventListener('mousemove', (event) => {
            if (!mouseDown) return;
            
            const deltaX = event.clientX - mouseX;
            const deltaY = event.clientY - mouseY;
            
            earth.rotation.y += deltaX * 0.01;
            earth.rotation.x += deltaY * 0.01;
            
            mouseX = event.clientX;
            mouseY = event.clientY;
        });
        
        // 滚轮缩放
        canvas.addEventListener('wheel', (event) => {
            const delta = event.deltaY > 0 ? 1.1 : 0.9;
            camera.position.multiplyScalar(delta);
            camera.position.clampLength(25, 200);
        });
    }
    
    // 动画循环
    function animate() {
        animationId = requestAnimationFrame(animate);
        
        // 自动旋转
        if (document.getElementById('auto-rotate').checked) {
            earth.rotation.y += 0.002;
        }
        
        renderer.render(scene, camera);
    }
    
    // 窗口大小调整
    function onWindowResize() {
        const container = document.getElementById('earth-container');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }
    
    // 更新飞机显示
    function updateAircraftDisplay(aircraftData) {
        // 清除现有飞机
        aircraftGroup.clear();
        
        // 添加新飞机
        Object.values(aircraftData).forEach(aircraft => {
            addAircraftToScene(aircraft);
        });
        
        // 更新飞机列表
        updateAircraftList(aircraftData);
        
        // 更新统计信息
        updateStatistics(aircraftData);
    }
    
    // 添加飞机到场景
    function addAircraftToScene(aircraft) {
        // 简化的飞机模型
        const geometry = new THREE.ConeGeometry(0.3, 1, 8);
        const material = new THREE.MeshBasicMaterial({ 
            color: getAircraftColor(aircraft.altitude) 
        });
        const aircraftMesh = new THREE.Mesh(geometry, material);
        
        // 根据ENU坐标计算位置
        const scale = 0.001; // 缩放因子
        aircraftMesh.position.set(
            aircraft.enu_e * scale,
            aircraft.enu_u * scale,
            aircraft.enu_n * scale
        );
        
        aircraftMesh.userData = aircraft;
        aircraftGroup.add(aircraftMesh);
    }
    
    // 根据高度获取飞机颜色
    function getAircraftColor(altitude) {
        if (altitude < 10000) return 0xff4444;      // 红色 - 低空
        if (altitude < 30000) return 0xffff44;      // 黄色 - 中空
        return 0x4444ff;                            // 蓝色 - 高空
    }
    
    // 更新飞机列表
    function updateAircraftList(aircraftData) {
        const listContainer = document.getElementById('aircraft-list');
        
        if (Object.keys(aircraftData).length === 0) {
            listContainer.innerHTML = '<p class="text-muted">暂无飞机数据</p>';
            return;
        }
        
        let html = '';
        Object.values(aircraftData).forEach(aircraft => {
            const distance = Math.sqrt(aircraft.enu_e**2 + aircraft.enu_n**2) / 1000;
            html += `
                <div class="aircraft-item" onclick="selectAircraft('${aircraft.icao}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="aircraft-emoji">${getAircraftEmoji(aircraft.altitude)}</span>
                            <strong>${aircraft.icao}</strong>
                        </div>
                        <small>${formatDistance(distance * 1000)}</small>
                    </div>
                    <small class="text-muted">
                        高度: ${formatAltitude(aircraft.altitude)}
                    </small>
                </div>
            `;
        });
        
        listContainer.innerHTML = html;
    }
    
    // 更新统计信息
    function updateStatistics(aircraftData) {
        const aircraftList = Object.values(aircraftData);
        
        if (aircraftList.length === 0) {
            document.getElementById('total-aircraft').textContent = '0';
            document.getElementById('avg-altitude').textContent = '0';
            document.getElementById('max-distance').textContent = '0';
            return;
        }
        
        const totalAircraft = aircraftList.length;
        const avgAltitude = Math.round(
            aircraftList.reduce((sum, a) => sum + a.altitude, 0) / totalAircraft
        );
        const maxDistance = Math.max(
            ...aircraftList.map(a => Math.sqrt(a.enu_e**2 + a.enu_n**2) / 1000)
        );
        
        document.getElementById('total-aircraft').textContent = totalAircraft;
        document.getElementById('avg-altitude').textContent = avgAltitude;
        document.getElementById('max-distance').textContent = maxDistance.toFixed(1);
    }
    
    // 选择飞机
    function selectAircraft(icao) {
        selectedAircraft = icao;
        
        // 更新UI
        document.querySelectorAll('.aircraft-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        event.target.closest('.aircraft-item').classList.add('selected');
        
        // 显示飞机详情
        showAircraftDetail(icao);
    }
    
    // 显示飞机详情
    function showAircraftDetail(icao) {
        const aircraft = aircraftData[icao];
        if (!aircraft) return;
        
        const distance = Math.sqrt(aircraft.enu_e**2 + aircraft.enu_n**2);
        
        showAlert('info', `
            <strong>飞机详情: ${aircraft.icao}</strong><br>
            位置: ${aircraft.latitude.toFixed(4)}°, ${aircraft.longitude.toFixed(4)}°<br>
            高度: ${formatAltitude(aircraft.altitude)}<br>
            距离: ${formatDistance(distance)}
        `, 8000);
    }
    
    // 重置视角
    function resetView() {
        camera.position.set(0, 0, 50);
        earth.rotation.set(0, 0, 0);
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        init3DScene();
        
        // 监听飞机数据更新
        document.addEventListener('aircraftDataUpdated', function(event) {
            updateAircraftDisplay(event.detail.aircraft);
        });
        
        // 过滤器事件
        document.getElementById('altitude-min').addEventListener('change', applyFilters);
        document.getElementById('altitude-max').addEventListener('change', applyFilters);
    });
    
    // 应用过滤器
    function applyFilters() {
        const minAlt = parseInt(document.getElementById('altitude-min').value) || 0;
        const maxAlt = parseInt(document.getElementById('altitude-max').value) || 50000;
        
        // 重新获取过滤后的数据
        fetch(`/api/aircraft/?altitude_min=${minAlt}&altitude_max=${maxAlt}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateAircraftDisplay(data.aircraft);
                }
            });
    }
</script>
{% endblock %}
