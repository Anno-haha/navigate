# ADS-B 导航数据处理系统 (nav.py)

## 核心设计思路

### 1. 模块化架构
- **SerialManager**: 串口通信管理
- **ADSBDecoder**: ADS-B消息解码
- **DataLogger**: 数据记录和日志
- **NavigationSystem**: 系统主控制器

### 2. 数据结构
- **AircraftPosition**: 飞机位置信息数据类，包含经纬度、高度和ECEF坐标
- **ECEFConverter**: 经纬度到地心地固坐标系转换器
- 使用 `@dataclass` 提供清晰的数据结构定义

### 3. 关键改进

#### 优势：
1. **面向对象设计**: 更好的代码组织和封装
2. **模块化**: 各组件职责明确，便于测试和维护
3. **类型提示**: 使用 typing 模块提供更好的代码提示
4. **错误处理**: 更完善的异常处理机制
5. **可扩展性**: 易于添加新功能和修改现有功能

## 系统组件详解

### ECEFConverter (坐标转换器)
```python
# 功能：
- 经纬度到地心地固坐标系(ECEF)转换
- 基于WGS84椭球模型
- 高精度数学计算
- 支持度/弧度转换
```

### SerialManager (串口管理器)
```python
# 功能：
- 自动检测可用串口
- 处理Windows高端口号格式
- 提供统一的串口读写接口
- 自动重连机制
```

### ADSBDecoder (消息解码器)
```python
# 功能：
- ADS-B消息格式验证
- 十六进制到二进制转换
- CPR位置解码算法
- 消息缓存管理
- 高度信息解码
```

### DataLogger (数据记录器)
```python
# 功能：
- 原始数据记录
- 解码结果记录
- 文件管理和刷新
- 时间戳格式化
```

### NavigationSystem (主系统)
```python
# 功能：
- 系统初始化和配置
- 组件协调管理
- 主处理循环
- 资源清理
```

## 使用方法

### 基本运行
```bash
python nav.py
```

### 测试系统
```bash
python test_nav.py
```

## 配置选项

### 串口配置
- 默认目标端口: COM10
- 波特率: 115200
- 数据格式: 8N1
- 超时: 1秒

### 缓存配置
- 消息缓存超时: 10秒
- 自动清理过期消息

### 日志配置
- 原始数据日志: `adsb_raw.log`
- 解码数据日志: `adsb_decoded.log` (包含ECEF坐标)
- 日志格式: `时间戳,ICAO,纬度,经度,高度(英尺),ECEF_X,ECEF_Y,ECEF_Z`

## 数据流程

```
串口数据 → SerialManager → 原始数据过滤 → ADSBDecoder → 位置解码 → DataLogger
                ↓                                    ↓
            原始日志记录                          控制台输出 + 解码日志
```

## 核心算法

### CPR位置解码
- 实现全球CPR解码算法
- 支持奇偶消息配对
- 自动处理经纬度范围调整
- NL(经度区域数量)计算

### 消息验证
- DF字段验证 (DF=17)
- 消息类型检查 (TC 9-18)
- 数据长度验证
- 格式完整性检查

## 扩展性

### 添加新功能
1. 继承现有类或创建新组件
2. 在 NavigationSystem 中集成
3. 更新配置和初始化逻辑

### 自定义解码器
```python
class CustomDecoder(ADSBDecoder):
    def decode_message(self, hex_data):
        # 自定义解码逻辑
        return super().decode_message(hex_data)
```

## 错误处理

- 串口连接失败自动重试
- 消息解码错误跳过处理
- 文件写入异常保护
- 系统资源自动清理

## 性能优化

- 消息缓存自动清理
- 文件缓冲区刷新
- 异常处理不中断主循环
- 内存使用优化

## 兼容性

- Windows/Linux 跨平台支持
- Python 3.7+ 兼容
- 自动处理编码问题
- 管理员权限检测

## 维护说明

定期检查：
1. 日志文件大小
2. 缓存清理效果
3. 串口连接稳定性
4. 解码成功率

## 故障排除

1. **串口连接失败**: 检查端口号和权限
2. **解码率低**: 检查数据格式和信号质量
3. **日志文件问题**: 检查磁盘空间和写入权限
4. **内存使用高**: 检查缓存清理机制
