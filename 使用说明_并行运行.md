# ADS-B 可视化系统 - 并行运行使用说明

## 🎯 问题解决

我已经成功解决了您提出的两个问题：

### ✅ 1. 避免终端nav.py进程
- **问题**: 运行simple_visual.py时会终端nav.py
- **解决方案**: 
  - 使用ThreadingTCPServer避免阻塞
  - 智能端口检测，自动选择可用端口
  - 添加启动检查，确保不冲突

### ✅ 2. 整合同一架飞机的数据
- **问题**: 飞机列表显示重复数据
- **解决方案**:
  - 为每架飞机维护完整的历史记录
  - 显示统计信息（最高/最低/平均高度）
  - 计算飞行时间和速度
  - 提供详细的坐标信息

## 🚀 启动方式

### 方式一：手动分别启动（推荐）
```bash
# 终端1：启动数据采集
python nav.py

# 终端2：启动可视化系统
python simple_visual.py
```

### 方式二：自动同时启动
```bash
# 一键启动两个程序
python start_both.py

# 快速检查系统状态
python start_both.py --check
```

## 📊 改进后的飞机数据显示

### 🆕 新增信息
每架飞机现在显示：

#### 📈 **统计信息**
- **更新次数**: 显示该飞机被检测到的次数
- **最高高度**: 记录的最高飞行高度
- **最低高度**: 记录的最低飞行高度  
- **平均高度**: 所有记录的平均高度
- **高度变化**: 如果变化超过1000英尺会特别标注

#### ⏰ **时间信息**
- **首次发现**: 第一次检测到该飞机的时间
- **最后更新**: 最近一次数据更新时间
- **跟踪时长**: 持续跟踪该飞机的总时间

#### 🚀 **动态信息**
- **当前速度**: 基于位置变化计算的速度
- **位置历史**: 保存最近20个位置点
- **高度历史**: 保存最近20个高度记录

### 🎨 **界面改进**
- **卡片式设计**: 每架飞机独立卡片显示
- **网格布局**: 信息分两列显示，更紧凑
- **颜色编码**: 重要信息用不同背景色突出
- **折叠详情**: 详细坐标信息可展开查看
- **状态指示**: 更新次数徽章显示

## 🔧 技术改进

### 🛡️ **进程隔离**
```python
# 使用ThreadingTCPServer避免阻塞
class ThreadingTCPServer(socketserver.ThreadingMixIn, socketserver.TCPServer):
    allow_reuse_address = True
    daemon_threads = True
```

### 📊 **数据整合算法**
```python
# 为每架飞机维护完整历史
aircraft_data[icao] = {
    'update_count': count,           # 更新次数
    'positions': [enu_coords],       # 位置历史
    'altitudes': [altitude],         # 高度历史
    'max_altitude': max_alt,         # 最高高度
    'min_altitude': min_alt,         # 最低高度
    'avg_altitude': avg_alt,         # 平均高度
    'speed': calculated_speed,       # 计算速度
    'first_seen': first_time,        # 首次发现
    'last_seen': last_time,          # 最后更新
}
```

### 🕒 **智能数据清理**
- **延长保留时间**: 从5分钟延长到10分钟
- **基于最后更新时间**: 使用last_seen而不是timestamp
- **清理日志**: 显示清理的飞机信息

## 📱 界面功能说明

### 🏠 **主页面**
- **实时状态**: 绿点表示系统在线
- **飞机计数**: 显示当前跟踪的飞机数量
- **自动刷新**: 每2秒自动更新数据
- **手动控制**: 可暂停/恢复自动刷新

### ✈️ **飞机卡片**
每个飞机卡片包含：
- **顶部**: 飞机emoji + ICAO代码 + 更新次数徽章
- **位置信息**: 当前经纬度坐标和距离
- **飞行信息**: 当前高度和计算速度
- **统计面板**: 高度统计（最高/最低/平均）
- **时间面板**: 发现时间和跟踪时长
- **详情折叠**: ENU坐标和位置历史

### 📊 **统计信息**
- **总飞机数**: 当前跟踪的飞机总数
- **平均高度**: 所有飞机的平均飞行高度
- **高度分布**: 低空/中空/高空飞机数量分布

## 🔍 使用技巧

### 💡 **最佳实践**
1. **先启动nav.py**: 确保数据采集稳定后再启动可视化
2. **检查端口**: 如果8000端口被占用，系统会自动选择其他端口
3. **监控状态**: 观察绿色状态点确认系统正常运行
4. **定期检查**: 注意飞机数据的更新时间

### 🚨 **故障排除**
1. **无飞机数据**: 检查nav.py是否正常运行
2. **端口冲突**: 系统会自动选择可用端口
3. **数据过期**: 超过10分钟无更新的飞机会被清理
4. **浏览器缓存**: 刷新页面获取最新数据

## 📈 **性能优化**

### 🎯 **数据处理**
- **增量读取**: 只处理新增的日志数据
- **智能缓存**: 保留最近20个位置和高度记录
- **自动清理**: 定期清理过期数据释放内存

### 🌐 **网络优化**
- **异步处理**: 使用线程处理HTTP请求
- **数据压缩**: JSON响应自动压缩
- **缓存控制**: 合理的数据刷新间隔

## 🔮 **未来扩展**

### 📊 **数据分析**
- 飞行轨迹可视化
- 速度变化图表
- 高度变化趋势
- 飞行模式识别

### 🎨 **界面增强**
- 3D轨迹显示
- 实时地图集成
- 移动端优化
- 主题切换

### 🚨 **告警功能**
- 高度异常告警
- 速度异常检测
- 飞机接近预警
- 数据中断提醒

## 🎉 **总结**

现在您的ADS-B可视化系统具备了：

✅ **并行运行**: nav.py和可视化系统可以同时运行  
✅ **数据整合**: 同一架飞机的所有信息整合显示  
✅ **智能统计**: 自动计算各种飞行统计信息  
✅ **友好界面**: 现代化的卡片式设计  
✅ **实时更新**: 持续跟踪飞机状态变化  

享受您的增强版ADS-B可视化系统！ ✈️📊🌍
